<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>設定</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 1rem;
        background: #fafafa;
        color: #222;
      }
      .logo-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
      }
      .logo {
        width: 259.2px;
        height: 144px;
        background: url("/images/logo_small.png") center/contain no-repeat;
      }
      h1 {
        margin: 0 0 1rem 0;
        font-size: 1.3rem;
      }
      label {
        display: block;
        margin: 0.6rem 0 0.2rem 0;
        font-weight: 600;
      }
      input[type="number"],
      select {
        padding: 0.4rem 0.5rem;
        font-size: 1rem;
        width: 240px;
      }
      .row {
        margin-bottom: 0.75rem;
      }
      button {
        padding: 0.45rem 0.8rem;
        font-size: 0.95rem;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="logo-row">
      <div class="logo" aria-label="logo"></div>
    </div>
    <h1 id="title">設定</h1>
    <div class="row">
      <label for="voice" id="label-voice">デフォルト音声</label>
      <select id="voice">
        <option value="nova">nova</option>
        <option value="sage">sage</option>
        <option value="cedar">cedar</option>
        <option value="onyx">onyx</option>
      </select>
    </div>
    <div class="row">
      <label for="speed" id="label-speed">TTS 速度</label>
      <input type="number" step="0.05" min="0.5" max="2.0" id="speed" />
    </div>
    <div class="row">
      <label for="default-source" id="label-source">デフォルト資料</label>
      <select id="default-source">
        <option value="">(指定なし)</option>
      </select>
    </div>
    <div class="row">
      <label for="native-lang" id="label-native">母語 / 翻訳先</label>
      <select id="native-lang">
        <option value="en">English</option>
        <option value="ko">한국어</option>
        <option value="zh">中文</option>
      </select>
    </div>
    <div class="row">
      <label for="font-scale" id="label-font">フォント倍率</label>
      <input type="number" step="0.05" min="0.6" max="2.0" id="font-scale" />
    </div>
    <div class="row">
      <label id="label-show-fg"><input type="checkbox" id="show-fg" /> 初期表示でFGをON</label>
    </div>
    <div class="row">
      <label id="label-show-hg"><input type="checkbox" id="show-hg" /> 初期表示でHGをON</label>
    </div>
    <div class="row">
      <label id="label-show-native"><input type="checkbox" id="show-native-defs" /> 母語の語義を表示</label>
    </div>
    <div class="row" style="margin-top:1rem; display:flex; gap:0.5rem;">
      <button id="save-btn">保存</button>
      <button id="reload-btn">再読み込み</button>
      <button id="back-btn">戻る</button>
      <button id="sources-btn">Go back to sources</button>
      <span id="status" style="font-size:0.95rem; color:#555;"></span>
    </div>

    <script>
      const voiceEl = document.getElementById("voice");
      const speedEl = document.getElementById("speed");
      const defaultSourceEl = document.getElementById("default-source");
      const fontScaleEl = document.getElementById("font-scale");
      const showFgEl = document.getElementById("show-fg");
      const showHgEl = document.getElementById("show-hg");
      const showNativeDefsEl = document.getElementById("show-native-defs");
      const nativeLangEl = document.getElementById("native-lang");
      const statusEl = document.getElementById("status");
      const sourcesBtn = document.getElementById("sources-btn");
      const reloadBtn = document.getElementById("reload-btn");

      const labels = {
        en: {
          title: "Settings",
          voice: "Default voice",
          speed: "TTS speed",
          source: "Default source",
          native: "Native language",
          font: "Font scale",
          showFg: "FG on by default",
          showHg: "HG on by default",
          showNative: "Display definitions in native language",
          save: "Save",
          reload: "Reload",
          back: "Back",
          sources: "Go back to sources",
          saving: "Saving...",
          saved: "Saved",
          saveFailed: "Save failed",
        },
        ko: {
          title: "설정",
          voice: "기본 음성",
          speed: "TTS 속도",
          source: "기본 자료",
          native: "모국어",
          font: "글꼴 배율",
          showFg: "기본 FG 켜기",
          showHg: "기본 HG 켜기",
          showNative: "모국어 풀이 표시",
          save: "저장",
          reload: "새로고침",
          back: "뒤로",
          sources: "Go back to sources",
          saving: "저장 중...",
          saved: "저장됨",
          saveFailed: "저장 실패",
        },
        zh: {
          title: "设置",
          voice: "默认语音",
          speed: "TTS 速度",
          source: "默认资料",
          native: "母语",
          font: "字体倍率",
          showFg: "默认开启 FG",
          showHg: "默认开启 HG",
          showNative: "显示母语释义",
          save: "保存",
          reload: "重载",
          back: "返回",
          sources: "Go back to sources",
          saving: "保存中…",
          saved: "已保存",
          saveFailed: "保存失败",
        },
      };
      let currentLocale = "en";

      function applyLocale(lang) {
        const l = labels[lang] || labels.en;
        currentLocale = lang in labels ? lang : "en";
        document.getElementById("title").textContent = l.title;
        document.getElementById("label-voice").firstChild.textContent = l.voice;
        document.getElementById("label-speed").firstChild.textContent = l.speed;
        document.getElementById("label-source").firstChild.textContent = l.source;
        document.getElementById("label-native").firstChild.textContent = l.native;
        document.getElementById("label-font").firstChild.textContent = l.font;
        document.getElementById("label-show-fg").lastChild.textContent = ` ${l.showFg}`;
        document.getElementById("label-show-hg").lastChild.textContent = ` ${l.showHg}`;
        document.getElementById("label-show-native").lastChild.textContent = ` ${l.showNative}`;
        document.getElementById("save-btn").textContent = l.save;
        document.getElementById("reload-btn").textContent = l.reload;
        document.getElementById("back-btn").textContent = l.back;
        document.getElementById("sources-btn").textContent = l.sources;
      }

      document.getElementById("back-btn").onclick = () => {
        window.location.href = "/static/sources.html";
      };

      sourcesBtn.onclick = () => {
        window.location.href = "/static/sources.html";
      };

      document.getElementById("save-btn").onclick = async () => {
        const payload = {
          default_voice: voiceEl.value,
          tts_speed: parseFloat(speedEl.value || "1.1"),
          default_source: defaultSourceEl.value || null,
          font_scale: parseFloat(fontScaleEl.value || "1.0"),
          show_fg: showFgEl.checked,
          show_hg: showHgEl.checked,
          native_lang: nativeLangEl.value || "en",
          show_native_defs: showNativeDefsEl.checked,
        };
        const l = labels[currentLocale] || labels.en;
        statusEl.textContent = l.saving;
        try {
          const res = await fetch("/api/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("save failed");
          statusEl.textContent = l.saved;
        } catch (err) {
          console.error(err);
          statusEl.textContent = l.saveFailed;
        }
      };

      reloadBtn.onclick = async () => {
        await document.getElementById("save-btn").onclick();
        window.location.reload();
      };

      async function loadSettings() {
        try {
          const res = await fetch("/api/settings");
          const data = await res.json();
          voiceEl.value = data.default_voice || "nova";
          speedEl.value = data.tts_speed ?? 1.1;
          fontScaleEl.value = data.font_scale ?? 1.0;
          showFgEl.checked = !!data.show_fg;
          showHgEl.checked = !!data.show_hg;
          nativeLangEl.value = data.native_lang || "en";
          showNativeDefsEl.checked = data.show_native_defs !== undefined ? !!data.show_native_defs : true;
          if (data.default_source) {
            defaultSourceEl.value = data.default_source;
          }
          applyLocale(nativeLangEl.value);
        } catch (err) {
          console.error(err);
        }
      }

      async function loadSources() {
        try {
          const res = await fetch("/api/source_list");
          const data = await res.json();
          const sources = data.sources || [];
          defaultSourceEl.innerHTML = '<option value="">(指定なし)</option>' +
            sources.map((s) => `<option value="${s.path || s.name}">${s.name}</option>`).join("");
        } catch (err) {
          console.error(err);
        }
      }

      (async () => {
        await loadSources();
        await loadSettings();
      })();
    </script>
  </body>
</html>

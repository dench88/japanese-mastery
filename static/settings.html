<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>設定</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 1rem;
        background: #fafafa;
        color: #222;
      }
      h1 {
        margin: 0 0 1rem 0;
        font-size: 1.3rem;
      }
      label {
        display: block;
        margin: 0.6rem 0 0.2rem 0;
        font-weight: 600;
      }
      input[type="number"],
      select {
        padding: 0.4rem 0.5rem;
        font-size: 1rem;
        width: 240px;
      }
      .row {
        margin-bottom: 0.75rem;
      }
      button {
        padding: 0.45rem 0.8rem;
        font-size: 0.95rem;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <script src="/static/auth.js"></script>
    <script>requireAuth();</script>
    <h1>設定</h1>
    <div class="row">
      <label for="voice">デフォルト音声</label>
      <select id="voice">
        <option value="nova">nova</option>
        <option value="sage">sage</option>
        <option value="cedar">cedar</option>
        <option value="onyx">onyx</option>
      </select>
    </div>
    <div class="row">
      <label for="speed">TTS 速度</label>
      <input type="number" step="0.05" min="0.5" max="2.0" id="speed" />
    </div>
    <div class="row">
      <label for="default-source">デフォルト資料</label>
      <select id="default-source">
        <option value="">(指定なし)</option>
      </select>
    </div>
    <div class="row">
      <label for="native-lang">母語 / 翻訳先</label>
      <select id="native-lang">
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="ko">한국어</option>
        <option value="zh">中文</option>
        <option value="fr">Français</option>
        <option value="es">Español</option>
      </select>
    </div>
    <div class="row">
      <label for="font-scale">フォント倍率</label>
      <input type="number" step="0.05" min="0.6" max="2.0" id="font-scale" />
    </div>
    <div class="row">
      <label><input type="checkbox" id="show-fg" /> 初期表示でFGをON</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="show-hg" /> 初期表示でHGをON</label>
    </div>
    <div class="row" style="margin-top:1rem; display:flex; gap:0.5rem;">
      <button id="save-btn">保存</button>
      <button id="back-btn">戻る</button>
      <button id="sources-btn">資料一覧</button>
      <span id="status" style="font-size:0.95rem; color:#555;"></span>
    </div>

    <script>
      const voiceEl = document.getElementById("voice");
      const speedEl = document.getElementById("speed");
      const defaultSourceEl = document.getElementById("default-source");
      const fontScaleEl = document.getElementById("font-scale");
      const showFgEl = document.getElementById("show-fg");
      const showHgEl = document.getElementById("show-hg");
      const nativeLangEl = document.getElementById("native-lang");
      const statusEl = document.getElementById("status");
      const sourcesBtn = document.getElementById("sources-btn");

      document.getElementById("back-btn").onclick = () => {
        window.location.href = "/static/sources.html";
      };

      sourcesBtn.onclick = () => {
        window.location.href = "/static/sources.html";
      };

      document.getElementById("save-btn").onclick = async () => {
        const payload = {
          default_voice: voiceEl.value,
          tts_speed: parseFloat(speedEl.value || "1.1"),
          default_source: defaultSourceEl.value || null,
          font_scale: parseFloat(fontScaleEl.value || "1.0"),
          show_fg: showFgEl.checked,
          show_hg: showHgEl.checked,
          native_lang: nativeLangEl.value || "en",
        };
        statusEl.textContent = "保存中…";
        try {
          const res = await authFetch("/api/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("save failed");
          statusEl.textContent = "保存しました";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "保存に失敗しました";
        }
      };

      async function loadSettings() {
        try {
          const res = await authFetch("/api/settings");
          const data = await res.json();
          voiceEl.value = data.default_voice || "nova";
          speedEl.value = data.tts_speed ?? 1.1;
          fontScaleEl.value = data.font_scale ?? 1.0;
          showFgEl.checked = !!data.show_fg;
          showHgEl.checked = !!data.show_hg;
          nativeLangEl.value = data.native_lang || "en";
          if (data.default_source) {
            defaultSourceEl.value = data.default_source;
          }
        } catch (err) {
          console.error(err);
        }
      }

      async function loadSources() {
        try {
          const res = await authFetch("/api/source_list");
          const data = await res.json();
          const sources = data.sources || [];
          defaultSourceEl.innerHTML = '<option value="">(指定なし)</option>' +
            sources.map((s) => `<option value="${s.path || s.name}">${s.name}</option>`).join("");
        } catch (err) {
          console.error(err);
        }
      }

      (async () => {
        await loadSources();
        await loadSettings();
      })();
    </script>
  </body>
</html>
